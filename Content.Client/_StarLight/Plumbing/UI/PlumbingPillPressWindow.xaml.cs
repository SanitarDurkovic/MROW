using Content.Shared._StarLight.Plumbing;
using Content.Shared.Chemistry;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.IoC;
using Robust.Shared.Localization;
using Robust.Shared.Utility;
using System.Numerics;

namespace Content.Client._StarLight.Plumbing.UI;

[GenerateTypedNameReferences]
public sealed partial class PlumbingPillPressWindow : DefaultWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;

    public event Action<bool>? OnToggle;
    public event Action<uint>? OnSetDosage;
    public event Action<uint>? OnSetPillType;
    public event Action<bool>? OnSetMixing;
    public event Action<PillPressInlet, float>? OnSetInletRatio;

    private bool _enabled = true;
    private bool _mixingEnabled;
    private bool _eastLastEdited = true;
    private const string PillsRsiPath = "/Textures/Objects/Specific/Chemistry/pills.rsi";
    private const int PillTypeCount = (int) SharedChemMaster.PillTypes;

    public Button[] PillTypeButtons { get; } = new Button[PillTypeCount];

    public PlumbingPillPressWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        ToggleStatusButton.OnPressed += _ =>
        {
            _enabled = !_enabled;
            UpdateToggleButton();
            OnToggle?.Invoke(_enabled);
        };


        DosageInput.Text = "10";
        SetDosageButton.OnPressed += _ =>
        {
            if (!uint.TryParse(DosageInput.Text, out var val) || val < 1 || val > 20)
                return;
            OnSetDosage?.Invoke(val);
        };

        MixingToggle.OnToggled += args =>
        {
            _mixingEnabled = args.Pressed;
            UpdateMixingVisibility();
            OnSetMixing?.Invoke(_mixingEnabled);
        };

        // Ratio inputs: typing in one auto-fills the other
        EastRatioInput.Text = "50";
        WestRatioInput.Text = "50";

        EastRatioInput.OnTextChanged += _ =>
        {
            _eastLastEdited = true;
            SetRatioButton.Disabled = false;

            if (float.TryParse(EastRatioInput.Text, out var val))
            {
                val = Math.Clamp(val, 0f, 100f);
                WestRatioInput.Text = ((int)(100f - val)).ToString();
            }
        };

        WestRatioInput.OnTextChanged += _ =>
        {
            _eastLastEdited = false;
            SetRatioButton.Disabled = false;

            if (float.TryParse(WestRatioInput.Text, out var val))
            {
                val = Math.Clamp(val, 0f, 100f);
                EastRatioInput.Text = ((int)(100f - val)).ToString();
            }
        };

        SetRatioButton.OnPressed += _ =>
        {
            // Send whichever was last edited; server sets both (complement)
            if (_eastLastEdited)
            {
                if (!float.TryParse(EastRatioInput.Text, out var val) || val < 0 || val > 100)
                    return;
                OnSetInletRatio?.Invoke(PillPressInlet.East, val);
            }
            else
            {
                if (!float.TryParse(WestRatioInput.Text, out var val) || val < 0 || val > 100)
                    return;
                OnSetInletRatio?.Invoke(PillPressInlet.West, val);
            }
            SetRatioButton.Disabled = true;
        };

        MixingContainer.Visible = false;

        // Pill type grid, same pattern as ChemMaster
        var spriteSystem = _entityManager.System<SpriteSystem>();
        var resourcePath = new ResPath(PillsRsiPath);
        var pillTypeGroup = new ButtonGroup();

        for (uint i = 0; i < PillTypeCount; i++)
        {
            var styleBase = SpinBox.MiddleButtonStyle;

            // Open-left for first in row, open-right for last in row
            if (i % 10 == 0)
                styleBase = SpinBox.LeftButtonStyle;
            else if (i % 10 == 9)
                styleBase = SpinBox.RightButtonStyle;

            PillTypeButtons[i] = new Button
            {
                StyleClasses = { styleBase },
                MaxSize = new Vector2(42, 28),
                Group = pillTypeGroup,
                ToggleMode = true,
            };

            var specifier = new SpriteSpecifier.Rsi(resourcePath, "pill" + (i + 1));
            var pillTypeTexture = new TextureRect
            {
                Texture = spriteSystem.Frame0(specifier),
                TextureScale = new Vector2(1.75f, 1.75f),
                Stretch = TextureRect.StretchMode.KeepCentered,
            };

            PillTypeButtons[i].AddChild(pillTypeTexture);
            PillTypeGrid.AddChild(PillTypeButtons[i]);

            var pillType = i;
            PillTypeButtons[i].OnPressed += _ =>
            {
                OnSetPillType?.Invoke(pillType);
            };
        }

        PillTypeButtons[0].Pressed = true;
    }

    private void UpdateToggleButton()
    {
        ToggleStatusButton.Text = _enabled
            ? Loc.GetString("plumbing-pill-press-enabled")
            : Loc.GetString("plumbing-pill-press-disabled");
    }

    private void UpdateMixingVisibility()
    {
        MixingContainer.Visible = _mixingEnabled;
    }

    public void UpdateState(PlumbingPillPressBoundUserInterfaceState state)
    {
        _enabled = state.Enabled;
        UpdateToggleButton();

        // Update dosage don't overwrite while user is typing
        if (!DosageInput.HasKeyboardFocus())
            DosageInput.Text = state.Dosage.ToString();

        if (state.PillType < PillTypeCount)
            PillTypeButtons[state.PillType].Pressed = true;

        _mixingEnabled = state.MixingEnabled;
        MixingToggle.Pressed = state.MixingEnabled;
        UpdateMixingVisibility();

        // Update ratio inputs and don't overwrite while user is typing
        if (!EastRatioInput.HasKeyboardFocus() && !WestRatioInput.HasKeyboardFocus())
        {
            EastRatioInput.Text = ((int) state.InletRatioEast).ToString();
            WestRatioInput.Text = ((int) state.InletRatioWest).ToString();
        }
    }
}
