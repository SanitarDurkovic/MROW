using Content.Shared._StarLight.Plumbing;
using Content.Shared.Chemistry.Reagent;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.IoC;
using Robust.Shared.Localization;
using Robust.Shared.Prototypes;

namespace Content.Client._StarLight.Plumbing.UI;

[GenerateTypedNameReferences]
public sealed partial class PlumbingFilterWindow : DefaultWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

    public event Action<bool>? OnToggle;
    public event Action<string>? OnAddReagent;
    public event Action<string>? OnRemoveReagent;
    public event Action? OnClear;

    private bool _enabled = true;
    private string? _selectedReagent;

    public PlumbingFilterWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        ToggleStatusButton.OnPressed += _ =>
        {
            _enabled = !_enabled;
            UpdateToggleButton();
            OnToggle?.Invoke(_enabled);
        };

        AddReagentButton.OnPressed += _ =>
        {
            var reagentId = ReagentIdInput.Text.Trim();
            if (string.IsNullOrEmpty(reagentId))
                return;

            OnAddReagent?.Invoke(reagentId);
            ReagentIdInput.Text = "";
            SuggestionList.Visible = false;
        };

        ReagentIdInput.OnTextChanged += _ => UpdateSuggestions(ReagentIdInput.Text);

        SuggestionList.OnItemSelected += args =>
        {
            var selected = args.ItemList[args.ItemIndex].Metadata as string;
            if (selected != null)
            {
                ReagentIdInput.Text = selected;
                SuggestionList.Visible = false;
            }
        };

        RemoveButton.OnPressed += _ =>
        {
            if (_selectedReagent != null)
                OnRemoveReagent?.Invoke(_selectedReagent);
        };

        ClearButton.OnPressed += _ => OnClear?.Invoke();

        FilteredList.OnItemSelected += args =>
        {
            _selectedReagent = args.ItemList[args.ItemIndex].Metadata as string;
            RemoveButton.Disabled = _selectedReagent == null;
        };

        FilteredList.OnItemDeselected += _ =>
        {
            _selectedReagent = null;
            RemoveButton.Disabled = true;
        };
    }

    private void UpdateToggleButton()
    {
        ToggleStatusButton.Text = _enabled
            ? Loc.GetString("plumbing-filter-enabled")
            : Loc.GetString("plumbing-filter-disabled");
    }

    public void UpdateState(PlumbingFilterBoundUserInterfaceState state)
    {
        _enabled = state.Enabled;
        UpdateToggleButton();

        FilteredList.Clear();
        foreach (var reagentId in state.FilteredReagents)
        {
            FilteredList.Add(new ItemList.Item(FilteredList)
            {
                Metadata = reagentId,
                Text = reagentId
            });
        }

        _selectedReagent = null;
        RemoveButton.Disabled = true;
    }

    private void UpdateSuggestions(string filter)
    {
        SuggestionList.Clear();

        if (string.IsNullOrWhiteSpace(filter))
        {
            SuggestionList.Visible = false;
            return;
        }

        var lowerFilter = filter.Trim().ToLowerInvariant();

        var matches = new List<ReagentPrototype>();

        foreach (var reagent in _prototypeManager.EnumeratePrototypes<ReagentPrototype>())
        {
            if (!reagent.ID.ToLowerInvariant().Contains(lowerFilter))
                continue;

            matches.Add(reagent);
        }

        matches.Sort((a, b) => a.ID.Length.CompareTo(b.ID.Length));

        foreach (var reagent in matches)
        {
            SuggestionList.Add(new ItemList.Item(SuggestionList)
            {
                Metadata = reagent.ID,
                Text = reagent.ID
            });
        }

        SuggestionList.Visible = SuggestionList.Count > 0;
    }
}
